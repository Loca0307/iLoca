<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>VidaLoca — Transaction</title>
    <link rel="stylesheet" href="../css/style.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="container center">
        <h1 class="site-title">VidaLoca — Transaction</h1>
      </div>
    </header>

    <main class="container home-main center">
      <div class="bets-card">
        <h3>Your Balance</h3>
        <p id="balance" class="large muted">Loading...</p>

        <div class="mt-1">
          <label>
            <input type="radio" name="mode" value="withdraw" checked /> Withdraw from bank
          </label>
          <label class="ml-2">
            <input type="radio" name="mode" value="deposit" /> Deposit to bank
          </label>
        </div>

        <label for="bankIban">Bank IBAN</label>
        <input id="bankIban" type="text" placeholder="IT00..." />
        <div class="mt-1">
          <span id="ibanInfo" class="muted ml-1"></span>
        </div>

        <label for="amount">Amount</label>
        <input id="amount" type="number" step="0.01" min="0" />

        <div class="mt-1">
          <button id="transactBtn" class="btn btn-primary">Withdraw</button>
        </div>

        <div class="mt-1">
          <a class="btn btn-ghost" href="/html/games.html">Back to Games</a>
        </div>

        <p id="msg" class="muted mt-1"></p>
      </div>
    </main>

    <footer class="site-footer center">
      <div class="container">
        <p class="small">© 2025 VidaLoca — All rights reserved</p>
      </div>
    </footer>

    <script>
      // Very similar logic to withdraw.html but supports two modes: withdraw (bank -> vida) and deposit (vida -> bank)
      const params = new URLSearchParams(window.location.search);
      const accountIdParam = params.get('accountId');
      const stored = localStorage.getItem('accountId');
      let accountId = accountIdParam ? Number(accountIdParam) : (stored ? Number(stored) : null);

      async function resolveAccount() {
        if (accountId && !isNaN(accountId)) return accountId;
        const loggedEmail = localStorage.getItem('VidaLoca/loggedInEmail');
        if (!loggedEmail) return null;
        try {
          const resp = await fetch(`/Account/GetAccountByEmail?email=${encodeURIComponent(loggedEmail)}`);
          if (!resp.ok) return null;
          const acct = await resp.json();
          if (acct && acct.accountId) {
            accountId = Number(acct.accountId);
            localStorage.setItem('accountId', String(accountId));
            return accountId;
          }
        } catch (err) { }
        return null;
      }

      async function fetchBalance() {
        if (!accountId || isNaN(accountId)) await resolveAccount();
        const el = document.getElementById('balance');
        if (!accountId || isNaN(accountId)) { el.innerText = 'No account selected'; return; }
        try {
          const res = await fetch(`/Account/GetBalanceByAccount?accountId=${accountId}`);
          if (!res.ok) { el.innerText = 'Unable to load balance'; return; }
          const balance = await res.json();
          el.innerText = Number(balance).toFixed(2) + ' €';
        } catch (e) { el.innerText = 'Balance: -'; }
      }

      // removed separate Verify button; verification happens when user confirms transact()

      function currentMode(){
        const r = document.querySelector('input[name="mode"]:checked');
        return r ? r.value : 'withdraw';
      }

      // update the button label when mode changes
      Array.from(document.querySelectorAll('input[name="mode"]')).forEach(r=> r.addEventListener('change', ()=>{
        const btn = document.getElementById('transactBtn');
        btn.innerText = currentMode() === 'withdraw' ? 'Withdraw' : 'Deposit';
        document.getElementById('msg').innerText = '';
      }));

      async function transact(){
        const raw = document.getElementById('amount').value;
        const amount = Number(raw);
        if (!amount || amount <= 0) { document.getElementById('msg').innerText = 'Enter a valid amount'; return; }
        const bankIban = document.getElementById('bankIban').value.trim();
        if (!bankIban) { document.getElementById('msg').innerText = 'Enter bank IBAN'; return; }
        if (!accountId || isNaN(accountId)) await resolveAccount();
        if (!accountId || isNaN(accountId)) { document.getElementById('msg').innerText = 'No account selected. Please log in.'; return; }

        const mode = currentMode();
        // Verify IBAN first (backend will still validate on the request)
        const ibanInfoEl = document.getElementById('ibanInfo');
        ibanInfoEl.innerText = '';
        try{
          const vres = await fetch(`/Account/VerifyBankIban?iban=${encodeURIComponent(bankIban)}`);
          if (!vres.ok) {
            document.getElementById('msg').innerText = 'IBAN not found. Check the IBAN or try another.';
            return;
          }
          const info = await vres.json();
          if (info && (info.firstName || info.lastName || info.email)) {
            ibanInfoEl.innerText = (info.firstName||'') + ' ' + (info.lastName||'') + (info.email ? ' ('+info.email+')' : '');
          }
        }catch(e){
          document.getElementById('msg').innerText = 'Failed to verify IBAN: network or server error.';
          return;
        }

        // Use the unified endpoint on the server; include IsDeposit flag for deposits
        const payload = { accountId, amount, bankIban, IsDeposit: mode === 'deposit' };
        const endpoint = '/Account/WithdrawFromBank';

        const res = await fetch(endpoint, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });

        const txt = await res.text();
        if (!res.ok) {
          // If deposit endpoint doesn't exist on server, inform the user
          if (mode === 'deposit') document.getElementById('msg').innerText = 'Deposit not implemented on server: ' + txt;
          else document.getElementById('msg').innerText = 'Withdraw failed: ' + txt;
        } else {
          document.getElementById('msg').innerText = (mode === 'withdraw' ? 'Withdraw successful' : 'Deposit successful');
          fetchBalance();
        }
      }

      document.getElementById('transactBtn').addEventListener('click', transact);

      fetchBalance();
    </script>
  </body>
</html>
