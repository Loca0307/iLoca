<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>VidaLoca — Withdraw</title>
    <link rel="stylesheet" href="../css/style.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="container center">
        <h1 class="site-title">VidaLoca — Withdraw</h1>
      </div>
    </header>

    <main class="container home-main center">
      <div class="bets-card">
        <h3>Your Balance</h3>
        <p id="balance" class="large muted">Loading...</p>
        

        <label for="bankIban">Bank IBAN</label>
        <input id="bankIban" type="text" placeholder="IT00..." />
        <div class="mt-1">
          <button id="verifyIbanBtn" class="btn btn-ghost">Verify IBAN</button>
          <span id="ibanInfo" class="muted ml-1"></span>
        </div>

        <label for="amount">Amount to withdraw</label>
        <input id="amount" type="number" step="0.01" min="0" />

        <div class="mt-1">
          <button id="withdrawBtn" class="btn btn-primary">Withdraw</button>
        </div>

        <div class="mt-1">
          <a class="btn btn-ghost" href="/html/games.html">Back to Games</a>
        </div>

        <p id="msg" class="muted mt-1"></p>
      </div>
    </main>

    <footer class="site-footer center">
      <div class="container">
        <p class="small">© 2025 VidaLoca — All rights reserved</p>
      </div>
    </footer>

    <script>
      // Resolve accountId from URL param or from localStorage. Do NOT default to 1.
      const params = new URLSearchParams(window.location.search);
      const accountIdParam = params.get('accountId');
      const stored = localStorage.getItem('accountId');
      let accountId = accountIdParam ? Number(accountIdParam) : (stored ? Number(stored) : null);

      async function resolveAccount() {
        if (accountId && !isNaN(accountId)) return accountId;
        const loggedEmail = localStorage.getItem('VidaLoca/loggedInEmail');
        if (!loggedEmail) return null;
        try {
          const resp = await fetch(`/Account/GetAccountByEmail?email=${encodeURIComponent(loggedEmail)}`);
          if (!resp.ok) return null;
          const acct = await resp.json();
          if (acct && acct.accountId) {
            accountId = Number(acct.accountId);
            localStorage.setItem('accountId', String(accountId));
            return accountId;
          }
        } catch (err) {
          // ignore
        }
        return null;
      }

      async function fetchBalance() {
        if (!accountId || isNaN(accountId)) {
          // attempt to resolve from logged-in email
          await resolveAccount();
        }
        if (!accountId || isNaN(accountId)) {
          document.getElementById('balance').innerText = 'No account selected';
          return;
        }
        const res = await fetch(`/Account/GetBalanceByAccount?accountId=${accountId}`);
        if (!res.ok) {
          document.getElementById('balance').innerText = 'Unable to load balance';
          return;
        }
        const balance = await res.json();
        document.getElementById('balance').innerText = Number(balance).toFixed(2) + ' €';
      }

        document.getElementById('verifyIbanBtn').addEventListener('click', async ()=>{
          const iban = document.getElementById('bankIban').value.trim();
          if (!iban) { document.getElementById('ibanInfo').innerText = 'Enter IBAN'; return; }
          const res = await fetch(`/Account/VerifyBankIban?iban=${encodeURIComponent(iban)}`);
          if (!res.ok) { document.getElementById('ibanInfo').innerText = 'Not found'; return; }
          const info = await res.json();
          document.getElementById('ibanInfo').innerText = info.firstName + ' ' + info.lastName + ' (' + info.email + ')';
        });

        document.getElementById('withdrawBtn').addEventListener('click', async ()=>{
        const raw = document.getElementById('amount').value;
        const amount = Number(raw);
        if (!amount || amount <= 0) {
          document.getElementById('msg').innerText = 'Enter a valid amount';
          return;
        }

          const bankIban = document.getElementById('bankIban').value.trim();
          if (!bankIban) { document.getElementById('msg').innerText = 'Verify bank IBAN first'; return; }

            if (!accountId || isNaN(accountId)) {
              // try to resolve account before failing
              await resolveAccount();
            }

            if (!accountId || isNaN(accountId)) {
              document.getElementById('msg').innerText = 'No account selected. Please log in.';
              return;
            }

          const payload = { accountId, amount, bankIban };
          const res = await fetch('/Account/WithdrawFromBank', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

        const txt = await res.text();
        if (!res.ok) {
          document.getElementById('msg').innerText = 'Withdraw failed: ' + txt;
        } else {
          document.getElementById('msg').innerText = 'Withdraw successful';
          fetchBalance();
        }
      });

  fetchBalance();
    </script>
  </body>
</html>
