# To define a service:
# 1) Define the build paths
# 2) Define the environment variables
# 3) Define the ports as host:container

services:
  # Docker setup for database with "new" access data
  db:
    image: postgres:15
    restart: unless-stopped
    # Load environment variables from .env file into db service
    env_file:
      - .env
    environment:
      POSTGRES_DB: ${DB_DATABASE}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data

  bankuumtubo:
    build: ./backend/BankuumTubo/Main
    # Load environment variables from .env file into backend service
    env_file:
      - .env
    ports:
      - "5027:5027"
    depends_on:
      - db
    environment:
      # Ensures the backend connects to the DB container correctly
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}

  vidaloca:
    build: ./backend/VidaLoca/Main
    env_file:
      - .env
    ports:
      - "5112:5112"
    depends_on:
      - db
    environment:
      # Ensures the backend connects to the DB container correctly
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}

  frontend:
    build:
      context: ./frontend/iLoca
    ports:
      - "3000:80"                 
    environment:
      # Provide both backend base URLs as environment variables so the frontend
      # build can target either direct container addresses (not recommended for
      # the browser) or be used for runtime config. Prefer using nginx proxy
      # rules and calling the APIs via relative paths from the browser (no CORS).
      - REACT_APP_VIDA_API=http://vidaloca:5112
      - REACT_APP_BANK_API=http://bankuumtubo:5027
    depends_on:
      - bankuumtubo
      - vidaloca
  

networks:
  default:
    name: iloca_network

volumes:
  postgres_data:
